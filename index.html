<!DOCTYPE html>
<html>
<head>
    <title>NoVA Data Center Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 60px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .sidebar {
        box-sizing: border-box;
        position: absolute;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
        padding: 30px;
        overflow-y: auto;
        transition: right 0.3s ease;
    }

    .sidebar.active {
        right: 0;
    }

    .close-btn {
        float: right;
        cursor: pointer;
        font-size: 24px;
    }

    .tab-bar {
        display: flex;
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
        z-index: 1001;
        position: relative;
    }

    .tab-btn {
        padding: 12px 24px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 500;
        color: #888;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s;
    }

    .tab-btn:hover {
        color: #333;
    }

    .tab-btn.active {
        color: #111;
        font-weight: 600;
        border-bottom: 2px solid #111;
    }

    .tab-panel {
        display: none;
        height: calc(100vh - 45px);
        position: relative;
    }

    .tab-panel.active {
        display: block;
    }
    </style>
</head>
<body>
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('map-tab', this)">Map</button>
        <button class="tab-btn" onclick="switchTab('tab2', this)">Tab 2</button>
    </div>

    <div id="map-tab" class="tab-panel active">
        <div class="info-panel">
            <div style="font-weight:600;margin-bottom:8px;font-size:14px;">Capacity (MW)</div>
            <div style="display:flex;flex-direction:column;gap:6px;font-size:13px;">
                <div style="display:flex;align-items:center;gap:8px;"><div style="width:14px;height:14px;background:#a00060;flex-shrink:0;"></div> &gt; 200 MW</div>
                <div style="display:flex;align-items:center;gap:8px;"><div style="width:14px;height:14px;background:#ff69b4;flex-shrink:0;"></div> 75 – 200 MW</div>
                <div style="display:flex;align-items:center;gap:8px;"><div style="width:14px;height:14px;background:#ff6600;flex-shrink:0;"></div> 20 – 75 MW</div>
                <div style="display:flex;align-items:center;gap:8px;"><div style="width:14px;height:14px;background:#ffaa00;flex-shrink:0;"></div> ≤ 20 MW</div>
                <div style="display:flex;align-items:center;gap:8px;"><div style="width:14px;height:14px;background:#999;flex-shrink:0;"></div> Unknown</div>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <span class="close-btn" onclick="closeSidebar()">×</span>
            <div id="facility-details"></div>
        </div>

        <div id="map"></div>
    </div>

    <div id="tab2" class="tab-panel">
        <div id="load-chart" style="width:50%;height:50%;"></div>
        <div id="load-chart-summer" style="width:50%;height:50%;"></div>
    </div>
    
    <!-- Plotly JS -->
    <script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<script>
    // Initialize map centered on NoVA
    var map = L.map('map', {
        wheelPxPerZoomLevel: 120,
        zoomSnap: 0.5,
        zoomDelta: 0.5
    }).setView([38.95, -77.35], 11);
    
    // Add base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Load US state boundaries and grey out non-Virginia states
    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
        .then(response => response.json())
        .then(states => {
            L.geoJSON(states, {
                style: function(feature) {
                    if (feature.properties.name === 'Virginia' || feature.properties.name === 'District of Columbia') {
                        return {
                            fillColor: 'transparent',
                            fillOpacity: 0,
                            color: 'transparent',
                            weight: 0
                        };
                    } else {
                        return {
                            fillColor: '#d3d3d3',
                            fillOpacity: 0.7,
                            color: 'transparent',
                            weight: 0
                        };
                    }
                },
                interactive: false
            }).addTo(map);
        });

    // Load Virginia counties and grey out all except target counties
    var focusCounties = ['51107', '51059', '51153', '51047', '51179', '51061', '51683', '51685', '51600', '51013', '51610', '51510']; // Loudoun, Fairfax, Prince William, Culpeper, Stafford, Fauquier, Manassas, Manassas Park, Fairfax City, Arlington, Falls Church, Alexandria
    fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json')
        .then(response => response.json())
        .then(counties => {
            counties.features = counties.features.filter(f => f.id && f.id.startsWith('51'));
            L.geoJSON(counties, {
                style: function(feature) {
                    if (focusCounties.includes(feature.id)) {
                        return {
                            fillColor: 'transparent',
                            fillOpacity: 0,
                            color: 'transparent',
                            weight: 0
                        };
                    } else {
                        return {
                            fillColor: '#d3d3d3',
                            fillOpacity: 0.7,
                            color: 'transparent',
                            weight: 0
                        };
                    }
                },
                interactive: false
            }).addTo(map);
        });

    // Load data
    fetch('data.json')
        .then(response => response.json())
        .then(data => {
            // Sort so null capacity (grey) renders first (behind colored markers)
            data.sort((a, b) => (a.capacity_mw === null ? -1 : 1) - (b.capacity_mw === null ? -1 : 1));
            data.forEach(facility => {
                // Create square marker using DivIcon
                var color = facility.capacity_mw === null ? '#999' : getColor(facility.capacity_mw);
                var icon = L.divIcon({
                    className: '',
                    html: '<div style="width:18px;height:18px;background:' + color + ';opacity:0.85;"></div>',
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                });
                var marker = L.marker([facility.lat, facility.lon], {
                    icon: icon,
                    zIndexOffset: facility.capacity_mw === null ? -1000 : 0
                });

                // Instead of bindPopup, use click event
                marker.on('click', function() {
                    showFacilityDetails(facility, marker, color);
                });

                marker.addTo(map);
            });
        });
    
    // Color scale by capacity (MW) — magenta/bright orange palette
    function getColor(mw) {
        return mw > 200 ? '#a00060' :
               mw > 75  ? '#ff69b4' :
               mw > 20  ? '#ff6600' :
                          '#ffaa00';
    }

    function calcExemptionScore(f) {
        var score = 0;

        // 1. Power (28 pts) - based on capacity_mw
        if (f.capacity_mw !== null && f.capacity_mw !== undefined) {
            if (f.capacity_mw <= 20) score += 28;
            else if (f.capacity_mw <= 75) score += 18;
            else if (f.capacity_mw <= 200) score += 7;
        }

        // 2. Environmental Justice (20 pts)
        var ejKeys = ['ej_particulate_matter','ej_ozone','ej_diesel_pm','ej_nitrogen_dioxide',
                      'ej_traffic','ej_hazardous_waste','ej_superfund','ej_rmp','ej_ust',
                      'ej_toxic_air','ej_wastewater','ej_lead_paint','ej_drinking_water'];
        var maxEj = 0;
        ejKeys.forEach(function(k) { if (f[k] !== null && f[k] > maxEj) maxEj = f[k]; });
        if (maxEj < 80) score += 20;

        // 3. Population (15 pts)
        if (f.pop_within_mile !== null && f.pop_within_mile !== undefined) {
            if (f.pop_within_mile < 1000) score += 15;
            else if (f.pop_within_mile < 5000) score += 10;
            else if (f.pop_within_mile < 10000) score += 5;
        }

        // 4. Water Stress (12 pts)
        var ws = f.water_stress_index || '';
        if (ws.indexOf('Low') === 0) score += 12;
        else if (ws === 'Medium - High (20-40%)') score += 6;

        // 5-8. Remaining 25 pts: all 0 (no data)

        return score;
    }

    function scoreTier(score) {
        if (score >= 80) return 'Full Exemption';
        if (score >= 60) return 'Partial Exemption';
        return 'No Exemption';
    }

    function scoreColor(score) {
        if (score >= 80) return '#16a34a';
        if (score >= 60) return '#ca8a04';
        return '#dc2626';
    }

    function fmt(val, suffix) {
        if (val === null || val === undefined) return 'N/A';
        return typeof val === 'number' ? val.toLocaleString() + (suffix || '') : val;
    }

    function waterStressStyle(val) {
        if (!val) return '';
        if (val.startsWith('High')) return 'background:#fee2e2;padding:2px 6px;border-radius:3px;font-size:13px;';
        if (val.startsWith('Low')) return 'background:#dbeafe;padding:2px 6px;border-radius:3px;font-size:13px;';
        return 'background:#fef3c7;padding:2px 6px;border-radius:3px;font-size:13px;';
    }

    function ejBar(label, val) {
        const pct = (val !== null && val !== undefined) ? val : null;
        const pos = pct !== null ? pct + '%' : '0%';
        const display = pct !== null ? Math.round(pct) : 'N/A';
        return `
            <div style="margin-bottom:12px;">
                <div style="font-size:13px;color:#555;margin-bottom:4px;">${label} <span style="float:right;font-weight:600;">${display}${pct !== null ? 'th' : ''}</span></div>
                <div style="position:relative;height:6px;background:#e5e7eb;border-radius:3px;">
                    ${pct !== null ? '<div style="position:absolute;top:-3px;left:calc(' + pos + ' - 4px);width:8px;height:12px;background:#333;border-radius:2px;"></div>' : ''}
                </div>
            </div>`;
    }

    var selectedMarker = null;
    var selectedMarkerColor = null;

    function selectMarker(marker, color) {
        // Remove border from previously selected marker
        if (selectedMarker) {
            var prevIcon = L.divIcon({
                className: '',
                html: '<div style="width:18px;height:18px;background:' + selectedMarkerColor + ';opacity:0.85;"></div>',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });
            selectedMarker.setIcon(prevIcon);
        }
        // Add black border to newly selected marker
        selectedMarker = marker;
        selectedMarkerColor = color;
        var newIcon = L.divIcon({
            className: '',
            html: '<div style="width:18px;height:18px;background:' + color + ';opacity:0.85;border:2px solid #000;box-sizing:border-box;"></div>',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
        });
        marker.setIcon(newIcon);
    }

    function showFacilityDetails(facility, marker, color) {
        document.getElementById('sidebar').classList.add('active');
        selectMarker(marker, color);

        const households = facility.capacity_mw !== null
            ? Math.round(facility.capacity_mw * 1000 / 1.2).toLocaleString()
            : 'N/A';

        document.getElementById('facility-details').innerHTML = `
            <h2>${facility.brand}</h2>
            <p style="color:#666;margin-top:-8px">${facility.company}</p>
            <p style="font-size:12px;color:#888;margin:2px 0;line-height:1.3;">${facility.address || 'N/A'}<br>${facility.city}, ${facility.county} County, VA ${facility.zip}</p>

            <table style="width:100%;border-collapse:collapse;font-size:13px;margin-top:14px;">
                <tr>
                    <td style="padding:6px 4px;color:#555;">Population within 1 mi</td>
                    <td style="text-align:right;padding:6px 4px;font-weight:600;">${fmt(facility.pop_within_mile)}</td>
                </tr>
                <tr>
                    <td style="padding:6px 4px;color:#555;">Water Stress Index</td>
                    <td style="text-align:right;padding:6px 4px;font-weight:600;"><span style="${waterStressStyle(facility.water_stress_index)}">${facility.water_stress_index || 'N/A'}</span></td>
                </tr>
                <tr>
                    <td style="padding:6px 4px;color:#555;">Electric Load Capacity</td>
                    <td style="text-align:right;padding:6px 4px;font-weight:600;"><span style="background:${facility.capacity_mw !== null ? getColor(facility.capacity_mw) + '30' : 'transparent'};padding:2px 6px;border-radius:3px;">${fmt(facility.capacity_mw, ' MW')}</span></td>
                </tr>
                <tr>
                    <td style="padding:6px 4px;color:#555;">Est. Load (50%)</td>
                    <td style="text-align:right;padding:6px 4px;font-weight:600;">${fmt(facility.est_load_50_mw, ' MW')}</td>
                </tr>
                <tr>
                    <td style="padding:6px 4px;color:#555;">Annual Load (50%)</td>
                    <td style="text-align:right;padding:6px 4px;font-weight:600;">${fmt(facility.annual_load_50_twh, ' TWh')}</td>
                </tr>
            </table>

            <div style="background:#f0f4ff;border-radius:6px;padding:10px;margin:12px 0;text-align:center;">
                <span style="font-size:12px;color:#555;">That's enough to power </span>
                <strong style="font-size:16px;">${households}</strong>
                <span style="font-size:12px;color:#555;"> homes</span>
            </div>

            <div style="background:#f9fafb;border-radius:6px;padding:10px;margin:12px 0;text-align:center;border:1px solid ${scoreColor(calcExemptionScore(facility))}30;">
                <span style="font-size:12px;color:#555;">Exemption Score </span>
                <strong style="font-size:16px;color:${scoreColor(calcExemptionScore(facility))};">${calcExemptionScore(facility)}/100</strong>
                <div style="font-size:11px;color:${scoreColor(calcExemptionScore(facility))};margin-top:2px;">${scoreTier(calcExemptionScore(facility))}</div>
            </div>

            <h3 style="font-size:13px;margin-top:28px;margin-bottom:14px;">Environmental Justice Scores - National Percentiles</h3>
            ${ejBar('Particulate Matter', facility.ej_particulate_matter)}
            ${ejBar('Diesel Particulate Matter', facility.ej_diesel_pm)}
            ${ejBar('Ozone', facility.ej_ozone)}
            ${ejBar('Nitrogen Dioxide', facility.ej_nitrogen_dioxide)}
        `;
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('active');
        if (selectedMarker) {
            var prevIcon = L.divIcon({
                className: '',
                html: '<div style="width:18px;height:18px;background:' + selectedMarkerColor + ';opacity:0.85;"></div>',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });
            selectedMarker.setIcon(prevIcon);
            selectedMarker = null;
            selectedMarkerColor = null;
        }
    }

    var chartBuilt = false;

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        if (tabId === 'map-tab') {
            map.invalidateSize();
        }
        if (tabId === 'tab2' && !chartBuilt) {
            buildChart();
        }
        if (tabId === 'tab2') {
            Plotly.Plots.resize('load-chart');
            Plotly.Plots.resize('load-chart-summer');
        }
    }

    function buildChart() {
        chartBuilt = true;
        fetch('daily_load.json')
            .then(r => r.json())
            .then(data => {
                var colors = { IAD: '#e67e22' };
                var order = ['IAD'];
                var traces = order.map(loc => ({
                    x: data[loc].dates,
                    y: data[loc].load,
                    name: '',
                    type: 'scatter',
                    mode: 'lines',
                    line: { width: 1.5, color: colors[loc] },
                    customdata: data[loc].temp.map(c => [c, Math.round(c * 9/5 + 32)]),
                    hovertemplate:
                        '%{y:.0f} MWh  %{customdata[0]:.0f}\u00B0C/%{customdata[1]}\u00B0F' +
                        '<extra></extra>'
                }));

                // Compute summer peak loads for annotations
                var iadDates = data['IAD'].dates;
                var iadLoad = data['IAD'].load;
                var summers = [
                    { year: 2023, x0: '2023-06-01', x1: '2023-08-31' },
                    { year: 2024, x0: '2024-06-01', x1: '2024-08-31' },
                    { year: 2025, x0: '2025-06-01', x1: '2025-08-31' }
                ];

                var shapes = summers.map(s => ({
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: s.x0, x1: s.x1,
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(255, 140, 0, 0.12)',
                    line: { width: 0 }
                }));

                var annotations = summers.map(s => {
                    var peakVal = 0;
                    for (var i = 0; i < iadDates.length; i++) {
                        var d = iadDates[i];
                        if (d >= s.x0 && d <= s.x1 && iadLoad[i] > peakVal) {
                            peakVal = iadLoad[i];
                        }
                    }
                    return {
                        x: s.x0.replace('-06-', '-07-').replace('-01', '-15'),
                        y: peakVal,
                        xref: 'x', yref: 'y',
                        text: 'Summer ' + s.year + '<br><b>' + Math.round(peakVal).toLocaleString() + ' MWh</b>',
                        showarrow: true,
                        arrowhead: 2,
                        ax: 0, ay: -35,
                        font: { family: 'Inter', size: 12 },
                        bgcolor: 'rgba(255,255,255,0.85)',
                        bordercolor: '#e67e22',
                        borderwidth: 1,
                        borderpad: 4
                    };
                });

                var layout = {
                    title: { text: 'Daily Average Load Over Time', font: { family: 'Inter', size: 18 } },
                    font: { family: 'Inter' },
                    xaxis: { title: 'Date', hoverformat: '%B %d, %Y' },
                    yaxis: { title: 'Load (MWh)' },
                    hovermode: 'x unified',
                    hoverlabel: { font: { family: 'Inter' } },
                    showlegend: false,
                    margin: { t: 60, b: 80, l: 70, r: 30 },
                    shapes: shapes,
                    annotations: annotations
                };

                Plotly.newPlot('load-chart', traces, layout, { responsive: true });

                // Pie chart: DC load, peak summer load, remaining capacity
                var GRID_CAPACITY = 27000;
                var DC_LOAD_50 = 10027;
                var PEAK_SUMMER = 23905;
                var OTHER_PEAK = PEAK_SUMMER - DC_LOAD_50;
                var REMAINING = GRID_CAPACITY - PEAK_SUMMER;

                var pieTrace = {
                    labels: ['Data Center Load', 'Peak Summer Load', 'Remaining Grid Capacity'],
                    values: [DC_LOAD_50, OTHER_PEAK, REMAINING],
                    type: 'pie',
                    marker: { colors: ['#333', '#e67e22', '#d3d3d3'] },
                    textinfo: 'percent',
                    textfont: { family: 'Inter', size: 14 },
                    hovertemplate: ['%{label}<br>%{value:,.0f} MW (%{percent})<extra></extra>',
                        '%{label}<br>' + PEAK_SUMMER.toLocaleString() + ' MW (incl. data centers)<extra></extra>',
                        '%{label}<br>%{value:,.0f} MW (%{percent})<extra></extra>']
                };

                var pieLayout = {
                    title: { text: 'Grid Capacity Breakdown', font: { family: 'Inter', size: 18 } },
                    font: { family: 'Inter' },
                    hoverlabel: { font: { family: 'Inter' } },
                    legend: { font: { family: 'Inter', size: 13 } },
                    margin: { t: 60, b: 40, l: 30, r: 30 }
                };

                Plotly.newPlot('load-chart-summer', [pieTrace], pieLayout, { responsive: true });
            });
    }
</script>
</body>
</html>